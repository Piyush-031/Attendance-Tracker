<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Attendance Tracker (Realtime)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- ðŸ”¹ Firebase v9+ via CDN (Step 4 + 5) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-analytics.js";
  import {
    getDatabase, ref, set, update, remove, onValue, child
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAWLvSff3A6MGCEvnYNEMx6FBgt2WmtYjM",
    authDomain: "attendance-tracker-3d50f.firebaseapp.com",
    projectId: "attendance-tracker-3d50f",
    storageBucket: "attendance-tracker-3d50f.firebasestorage.app",
    messagingSenderId: "964548367673",
    appId: "1:964548367673:web:56555eda44c5baafa9c4e8",
    measurementId: "G-3039FSY9XN",
    databaseURL: "https://attendance-tracker-3d50f-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e){ /* analytics may require https + cookie consent; safe to ignore */ }

  const db = getDatabase(app);
  const attendanceRef = ref(db, "attendanceData");
  const employeesRef  = ref(db, "employees");

  // Expose helpers to the rest of the page (which uses a non-module script)
  window._db = { db, attendanceRef, employeesRef, ref, set, update, remove, onValue, child };
  console.log("[Firebase] initialized, realtime DB ready.");
</script>

<style>
:root {
  --card-bg: rgba(30,30,30,0.6);
  --card-hover: rgba(45,45,45,0.85);
  --text-color: #f1f1f1;
  --neon-teal: #00b894;
  --neon-blue: #0984e3;
  --button-gradient: linear-gradient(90deg,#0984e3,#6c5ce7);
  --wfo-color: #2ecc71;
  --wfh-color: #3498db;
  --leave-color: #e74c3c;
  --holiday-color: #f1c40f;
}

* { box-sizing: border-box; }

body {
  font-family: 'Poppins', sans-serif;
  margin:0; padding:0;
  background: linear-gradient(-45deg, #0b132b, #1c2541, #3a506b, #5bc0be, #1e3c72, #6a11cb, #ff9a9e, #fbc531);
  background-size: 800% 800%;
  animation: galaxyShift 40s ease infinite;
  color: #000;
  overflow-x: hidden;
  position: relative;
}
@keyframes galaxyShift {
  0%   { background-position:   0% 50%; }
  50%  { background-position: 100% 50%; }
  100% { background-position:   0% 50%; }
}

/* Overlay for readability */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  pointer-events: none;
  z-index: 0;
}

/* Starfield + particle canvases */
#stars-bg, #particles-bg {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
}

/* RGB Nebula â€” color-cycling background blob */
.rgb-nebula{
  position: fixed;
  inset: -15vmax;
  z-index: 0;
  filter: blur(80px) saturate(140%);
  opacity: .45;
  background:
    radial-gradient(40vmax 40vmax at 20% 30%, #ff0080 0%, transparent 60%),
    radial-gradient(35vmax 35vmax at 80% 20%, #00e5ff 0%, transparent 60%),
    radial-gradient(55vmax 55vmax at 50% 75%, #7cff00 0%, transparent 65%);
  animation: nebulaDrift 28s ease-in-out infinite alternate,
             hueCycle 18s linear infinite;
  pointer-events:none;
}
@keyframes nebulaDrift {
  0%   { transform: translate3d(-2vmax,-1vmax,0) scale(1); }
  100% { transform: translate3d( 2vmax, 1vmax,0) scale(1.05); }
}
@keyframes hueCycle { to { filter: hue-rotate(360deg) blur(80px) saturate(140%); } }

/* Title */
header {
  text-align: center;
  font-size: 3em;
  font-weight: 700;
  padding: 25px;
  margin-bottom: 20px;
  position: relative;
  z-index: 1;
  background: linear-gradient(90deg, #fff, #00b894, #0984e3, #fff);
  background-size: 300% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: shimmer 8s infinite linear;
}
@keyframes shimmer {
  0% { background-position: 0% 50%; }
  100% { background-position: 300% 50%; }
}

/* Live IST clock */
.clock {
  position: fixed;
  top: 12px;
  right: 18px;
  z-index: 5;
  color: #f1f1f1;
  font-weight: 600;
  letter-spacing: .3px;
  padding: 6px 12px;
  border-radius: 12px;
  background: #141414; /* solid */
  border: 1px solid rgba(255,255,255,0.15);
  box-shadow: 0 6px 16px rgba(0,0,0,0.35);
  backdrop-filter: none;
  text-shadow: 0 0 8px rgba(9,132,227,0.6);
}

.container {
  display:flex; flex-direction:column; gap:25px; padding:20px; max-width:1200px; margin:auto;
  position: relative;
  z-index: 1;
}

/* Cards â€” thick slab + neon rim, no tilt */
.card {
  background: var(--card-bg);
  border-radius:20px;
  padding:25px;
  color: var(--text-color);
  backdrop-filter: blur(15px);
  transition: transform 0.4s ease, box-shadow 0.4s ease, background 0.4s ease;
  border: 1px solid transparent;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    0 14px 28px rgba(0,0,0,.35);
  position: relative;
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.8s ease forwards;
}
.card:hover { 
  background: var(--card-hover);
  transform: translateY(-8px);
  box-shadow: 0 22px 50px rgba(0,0,0,.48);
}
.card::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 20px;
  padding: 2px;
  background: linear-gradient(135deg, #0984e3, #6c5ce7, #00b894);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
          mask-composite: exclude;
  pointer-events: none;
  box-shadow:
    0 0 18px rgba(9,132,227,.28),
    0 0 26px rgba(0,184,148,.18);
}
/* fake thickness layer */
.card::after{
  content:"";
  position:absolute;
  inset:10px -8px -8px -8px;
  border-radius:22px;
  background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
  filter: blur(10px);
  z-index:-1;
  pointer-events:none;
}

@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

.section-title {
  font-size:1.6em; margin-bottom:15px; font-weight:600;
  border-bottom:1px solid rgba(255,255,255,0.2);
  padding-bottom:8px; letter-spacing:0.5px;
  color: var(--neon-blue);
  text-shadow: 0 0 8px rgba(9,132,227,0.8), 0 0 15px rgba(9,132,227,0.5);
  position: relative;
}
/* holographic underline */
.section-title::after{
  content:"";
  position:absolute; left:0; right:0; bottom:-2px; height:2px;
  background: linear-gradient(90deg, #ff3b3b, #ffd93b, #3bff7c, #3bbdff, #9d3bff, #ff3bcb);
  background-size: 300% 100%;
  animation: lineShift 10s linear infinite;
  opacity:.85;
}
@keyframes lineShift{ to { background-position: 300% 0; } }

input, #monthPicker, #dayPicker, #monthlyPicker, #fileInput, select {
  padding:10px 18px; border-radius:25px; border:1px solid #555; outline:none; transition: all 0.3s ease; width:220px;
  color:#f1f1f1; background: rgba(0,0,0,0.6);
  font-weight:500;
}
input:focus, #monthPicker:focus, #dayPicker:focus, #monthlyPicker:focus, #fileInput:focus, select:focus {
  box-shadow:0 0 12px var(--neon-teal);
  transform:scale(1.05);
}

select:hover {
  border-color: var(--neon-blue);
  box-shadow: 0 0 8px var(--neon-blue);
}

select option[value="WFO"] { background-color: var(--card-bg); color: var(--wfo-color); }
select option[value="WFH"] { background-color: var(--card-bg); color: var(--wfh-color); }
select option[value="Leave"] { background-color: var(--card-bg); color: var(--leave-color); }
select option[value="Holiday"] { background-color: var(--card-bg); color: var(--holiday-color); }

button {
  padding:10px 22px; border:none; border-radius:25px; cursor:pointer; margin:4px;
  background: var(--button-gradient);
  color:white; font-weight:bold; transition:0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
button:hover { 
  filter: brightness(1.2); 
  transform: scale(1.08);
  box-shadow: 0 0 12px var(--neon-blue), 0 0 18px var(--neon-teal);
}

/* Table */
.table-wrapper { overflow-x: auto; max-width: 100%; isolation: isolate; }
.table-container { display: inline-block; }

/* --- TABLE CARD SOLID (no blur) to avoid sticky artifacts --- */
.card.table-card,
.card.table-card:hover {
  background: #141414;  /* solid */
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    0 14px 28px rgba(0,0,0,.35);
}

table {
  border-collapse: collapse;
  min-width: 800px;
  background: rgba(0,0,0,0.65);
  color: #f1f1f1;
}

th, td {
  border:1px solid rgba(255,255,255,0.2);
  padding:10px;
  text-align:center;
  white-space:nowrap;
}
th {
  background: rgba(20,20,20,0.95);
  position: sticky;
  top: 0;
  z-index: 3;
}

/* OPAQUE sticky first column (no transparency on scroll or hover) */
td:first-child,
th:first-child{
  position: sticky;
  left: 0;
  background: #141414;     /* solid */
  z-index: 10;
  transform: translateZ(0);
  will-change: transform;
  box-shadow: 6px 0 8px rgba(0,0,0,0.35);
}
th:first-child{ z-index: 11; }

/* Row hover â€” EXCLUDE first column so it stays solid */
table tr:hover td:not(.weekend):not(:first-child) {
  background: rgba(255,255,255,0.15);
  box-shadow: inset 0 0 8px rgba(9,132,227,0.5);
  transition: 0.25s;
}

table tr:nth-child(even) td { background: rgba(255,255,255,0.05); }
.weekend { background: rgba(50,50,50,0.5); color:#bbb; pointer-events:none; }

/* Charts */
.charts { display: flex; justify-content: space-between; gap: 20px; flex-wrap: nowrap; }
.chart-container { 
  flex:1; height:380px; border-radius:18px; padding:20px; 
  background: rgba(20,20,20,0.55); 
  display:flex; flex-direction: column; 
  box-shadow:
    0 12px 28px rgba(0,0,0,.42),
    0 0 24px rgba(9,132,227,.16) inset;
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.15);
  overflow: hidden;
}
.chart-title { text-align:center; font-weight:700; font-size:1.4em; margin-bottom:12px; color:#f1f1f1; }

input[type="month"]::-webkit-calendar-picker-indicator,
input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1);
  cursor: pointer;
}

/* Search card */
.search-card {
  display:flex; align-items:center; flex-wrap:wrap; gap:12px;
  margin:12px 0 18px 0; padding:16px;
  border-radius:16px; background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
}
.search-card .mini-title {
  font-size:1.1em; font-weight:600; color:#f1f1f1; margin-right:8px;
}
#employeeSearch { width:280px; }
.badge {
  display:inline-block; padding:6px 10px; border-radius:999px; font-size:0.85em; font-weight:600; margin-right:8px;
  border: 1px solid rgba(255,255,255,0.2);
}
.badge.wfo { background: rgba(46, 204, 113, 0.18); color:#d7fbe3; }
.badge.wfh { background: rgba(52, 152, 219, 0.18); color:#d7ecfb; }
.badge.leave { background: rgba(231, 76, 60, 0.18); color:#ffd6d1; }
.badge.holiday { background: rgba(241, 196, 15, 0.18); color:#fff5c7; }
#searchSummary { margin-left:6px; display:flex; align-items:center; gap:8px; }
.highlight-row { box-shadow: inset 0 0 0 2px rgba(9,132,227,0.6); }
</style>
</head>
<body>

<!-- Live IST clock -->
<div id="clock" class="clock">--:--:-- -- | -- --- ----</div>

<!-- Twinkling stars & particle network -->
<canvas id="stars-bg"></canvas>
<canvas id="particles-bg"></canvas>

<!-- RGB Nebula layer -->
<div class="rgb-nebula" aria-hidden="true"></div>

<header>Data Transformers</header>

<div class="container">

  <div class="card">
    <div class="section-title">Employee Management</div>
    <div id="employeeList">
      <input type="text" id="employeeName" placeholder="Enter employee name">
      <button onclick="addEmployee()">Add</button>
      <button onclick="removeEmployee()">Remove</button>
    </div>
  </div>

  <!-- TABLE CARD marked solid to avoid sticky transparency -->
  <div class="card table-card">
    <div class="section-title">Attendance Table</div>

    <div class="search-card">
      <span class="mini-title">Search Employee Presence:</span>
      <input type="text" id="employeeSearch" list="employeeSuggestions" placeholder="Type employee name..." />
      <datalist id="employeeSuggestions"></datalist>
      <button onclick="applyEmployeeFilter()">Search</button>
      <button onclick="clearEmployeeFilter()">Clear</button>
      <div id="searchSummary"></div>
    </div>

    <label for="monthPicker">Select Month for Table: </label>
    <input type="month" id="monthPicker" onchange="generateTable()">
    <div class="table-wrapper">
      <div class="table-container">
        <table id="attendanceTable"></table>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="section-title">Bulk Update Attendance</div>
    <label>Status: </label>
    <select id="bulkStatus">
      <option value="WFO">WFO</option>
      <option value="WFH">WFH</option>
      <option value="Leave">Leave</option>
      <option value="Holiday">Holiday</option>
    </select>
    <label>Start Day: </label>
    <input type="number" id="bulkStart" min="1" max="31">
    <label>End Day: </label>
    <input type="number" id="bulkEnd" min="1" max="31">
    <button onclick="applyBulkUpdate()">Apply</button>
  </div>

  <div class="card">
    <div class="section-title">Save / Upload Data</div>
    <button onclick="saveToExcel()">SAVE FILE</button>
    <button onclick="document.getElementById('fileInput').click()">UPLOAD FILE</button>
    <input type="file" id="fileInput" accept=".xlsx" style="display:none" onchange="loadFromExcel(event)">
  </div>

  <div class="card">
    <div class="section-title">Visualizations</div>
    <label>
      <input type="checkbox" id="monthlyToggle" onchange="toggleMonthlyView()"> Show Monthly View
    </label>
    <input type="month" id="monthlyPicker" style="display:none; margin-left:20px;" onchange="updateCharts()">
    <label for="dayPicker" style="margin-left:20px;">Select Day: </label>
    <input type="date" id="dayPicker" onchange="updateCharts()">
    <div class="charts" style="margin-top:15px;">
      <div class="chart-container">
        <div class="chart-title">Attendance Distribution</div>
        <canvas id="barChart"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Monthly Summary</div>
        <canvas id="stackedChart"></canvas>
      </div>
    </div>
  </div>

</div>

<script>
/* === Chart.js plugin to add subtle bar depth (no layout change) === */
const DepthBars = {
  id: 'depthBars',
  afterDatasetsDraw(chart){
    const {ctx} = chart;
    ctx.save();
    ctx.shadowColor = 'rgba(0,0,0,.35)';
    ctx.shadowBlur = 12;
    ctx.shadowOffsetY = 6;

    chart.getSortedVisibleDatasetMetas().forEach(meta=>{
      if (meta.type !== 'bar') return;
      meta.data.forEach(el=>{
        if (!el || !el.base) return;
        const {x,y,base,width} = el.getProps(['x','y','base','width'], true);
        const left = x - width/2;
        const top = y;
        const height = base - y;

        const grad = ctx.createLinearGradient(0, top, 0, top + height);
        grad.addColorStop(0, 'rgba(255,255,255,.10)');
        grad.addColorStop(1, 'rgba(0,0,0,.10)');

        ctx.fillStyle = grad;
        ctx.fillRect(left, top, width, height);
      });
    });

    ctx.restore();
  }
};
Chart.register(DepthBars);

/* === Twinkling Stars === */
(function(){
  const canvas = document.getElementById('stars-bg');
  const ctx = canvas.getContext('2d');
  let stars = [], width, height, devicePxRatio;

  function resize(){
    width = window.innerWidth;
    height = window.innerHeight;
    devicePxRatio = window.devicePixelRatio || 1;
    canvas.width = Math.floor(width * devicePxRatio);
    canvas.height = Math.floor(height * devicePxRatio);
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    ctx.setTransform(devicePxRatio, 0, 0, devicePxRatio, 0, 0);
    initStars();
  }
  function initStars(){
    stars=[];
    const count = Math.min(220, Math.max(120, Math.floor(width * height * 0.00012)));
    for(let i=0;i<count;i++){
      stars.push({ x:Math.random()*width, y:Math.random()*height, r:Math.random()*1.6+0.4, alpha:Math.random(), dAlpha:(Math.random()*0.02+0.006)*(Math.random()<0.5?-1:1) });
    }
  }
  function animate(){
    ctx.clearRect(0,0,width,height);
    for(const s of stars){
      s.alpha += s.dAlpha;
      if(s.alpha <= 0){ s.alpha = 0; s.dAlpha *= -1; }
      else if(s.alpha >= 1){ s.alpha = 1; s.dAlpha *= -1; }
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
      ctx.shadowBlur = 8; ctx.shadowColor = "rgba(255,255,255,0.8)";
      ctx.fill(); ctx.shadowBlur = 0;
    }
    requestAnimationFrame(animate);
  }
  window.addEventListener('resize', resize, { passive:true });
  resize(); animate();
})();

/* === Particle Background === */
(function(){
  const canvas = document.getElementById('particles-bg');
  const ctx = canvas.getContext('2d');
  let particles = [], width, height, devicePxRatio;

  function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    devicePxRatio = window.devicePixelRatio || 1;
    canvas.width = Math.floor(width * devicePxRatio);
    canvas.height = Math.floor(height * devicePxRatio);
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    ctx.setTransform(devicePxRatio, 0, 0, devicePxRatio, 0, 0);
    initParticles();
  }

  function initParticles() {
    const density = 0.00012;
    const targetCount = Math.min(220, Math.max(80, Math.floor(width * height * density)));
    particles = [];
    for (let i = 0; i < targetCount; i++) {
      particles.push({ x:Math.random()*width, y:Math.random()*height, vx:(Math.random()-0.5)*0.6, vy:(Math.random()-0.5)*0.6, r:Math.random()*1.6+0.6, a:Math.random()*0.6+0.3 });
    }
  }

  function step() {
    ctx.clearRect(0, 0, width, height);
    const maxDist = Math.min(160, Math.max(90, Math.min(width, height) * 0.18));

    for (let i = 0; i < particles.length; i++) {
      const p = particles[i];
      p.x += p.vx; p.y += p.vy;
      if (p.x < -10) p.x = width + 10;
      if (p.x > width + 10) p.x = -10;
      if (p.y < -10) p.y = height + 10;
      if (p.y > height + 10) p.y = -10;

      ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255,255,255,' + p.a + ')';
      ctx.shadowBlur = 12; ctx.shadowColor = "rgba(255,255,255,0.6)";
      ctx.fill(); ctx.shadowBlur = 0;
    }

    ctx.lineWidth = 0.7;
    for (let i = 0; i < particles.length; i++) {
      for (let j = i + 1; j < particles.length; j++) {
        const p1 = particles[i], p2 = particles[j];
        const dx = p1.x - p2.x, dy = p1.y - p2.y;
        const dist2 = dx*dx + dy*dy;
        if (dist2 < maxDist*maxDist) {
          const dist = Math.sqrt(dist2);
          const alpha = 1 - dist / maxDist;
          ctx.strokeStyle = 'rgba(255,255,255,' + (alpha * 0.25) + ')';
          ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
        }
      }
    }
    requestAnimationFrame(step);
  }
  window.addEventListener('resize', resize, { passive: true });
  resize(); requestAnimationFrame(step);
})();

/* === Live IST Clock === */
(function istClock(){
  const el = document.getElementById('clock');
  function tick(){
    const now = new Date();
    const fmtTime = new Intl.DateTimeFormat('en-IN',{
      timeZone:'Asia/Kolkata', hour:'numeric', minute:'2-digit', second:'2-digit', hour12:true
    }).format(now);
    const fmtDate = new Intl.DateTimeFormat('en-IN',{
      timeZone:'Asia/Kolkata', weekday:'short', day:'2-digit', month:'short', year:'numeric'
    }).format(now);
    el.textContent = `${fmtTime} | ${fmtDate}`;
  }
  tick();
  setInterval(tick, 1000);
})();

/* === APP LOGIC (Realtime via Firebase) === */
let employees = [];
let attendanceData = {};
let barChart, stackedChart;
const colors = {"WFO":"#2ecc71","WFH":"#3498db","Leave":"#e74c3c","Holiday":"#f1c40f"};

/* ===== Search helpers ===== */
function refreshEmployeeDatalist(){
  const dl = document.getElementById("employeeSuggestions");
  if(!dl) return;
  dl.innerHTML = "";
  employees.slice().sort((a,b)=>a.localeCompare(b)).forEach(emp=>{
    const opt = document.createElement("option");
    opt.value = emp;
    dl.appendChild(opt);
  });
}
function applyEmployeeFilter(){
  const input = document.getElementById("employeeSearch");
  const nameRaw = input.value.trim();
  if(!nameRaw){ clearEmployeeFilter(); return; }

  let match = employees.find(e => e.toLowerCase() === nameRaw.toLowerCase());
  if(!match){
    match = employees.find(e => e.toLowerCase().startsWith(nameRaw.toLowerCase())) ||
            employees.find(e => e.toLowerCase().includes(nameRaw.toLowerCase()));
  }
  if(!match){ 
    clearEmployeeFilter();
    return;
  }
  const table = document.getElementById("attendanceTable");
  const rows = Array.from(table.querySelectorAll("tr"));
  rows.forEach((tr, idx)=>{
    if(idx === 0){ tr.style.display = ""; return; } // header
    const empCell = tr.querySelector("td:first-child");
    if(!empCell) return;
    const isTarget = empCell.textContent.trim() === match;
    tr.style.display = isTarget ? "" : "none";
    tr.classList.toggle("highlight-row", isTarget);
  });
  updateSearchSummary(match);
  const targetRow = table.querySelector("tr.highlight-row");
  if(targetRow) targetRow.scrollIntoView({behavior:"smooth", block:"nearest"});
}
function clearEmployeeFilter(){
  const table = document.getElementById("attendanceTable");
  Array.from(table.querySelectorAll("tr")).forEach((tr)=>{ tr.style.display = ""; tr.classList.remove("highlight-row"); });
  document.getElementById("searchSummary").innerHTML = "";
}
function updateSearchSummary(employeeName){
  const monthVal = document.getElementById("monthPicker").value;
  const summaryEl = document.getElementById("searchSummary");
  summaryEl.innerHTML = "";
  if(!employeeName || !monthVal) return;

  const [year, monthNum] = monthVal.split("-");
  const daysInMonth = new Date(year, monthNum, 0).getDate();
  const counts = { WFO:0, WFH:0, Leave:0, Holiday:0 };

  for(let d=1; d<=daysInMonth; d++){
    const key = `${employeeName}_${year}-${monthNum}-${d}`;
    const val = attendanceData[key];
    if(counts.hasOwnProperty(val)) counts[val]++;
  }

  const makeBadge = (label, cls, count) => {
    const span = document.createElement("span");
    span.className = `badge ${cls}`;
    span.textContent = `${label}: ${count}`;
    return span;
  };
  summaryEl.appendChild(makeBadge("WFO","wfo",counts.WFO));
  summaryEl.appendChild(makeBadge("WFH","wfh",counts.WFH));
  summaryEl.appendChild(makeBadge("Leave","leave",counts.Leave));
  summaryEl.appendChild(makeBadge("Holiday","holiday",counts.Holiday));
}
/* ===== End search helpers ===== */

function generateTable(){
  const month=document.getElementById("monthPicker").value; if(!month) return;
  const [year, monthNum]=month.split("-");
  const daysInMonth=new Date(year,monthNum,0).getDate();
  const table=document.getElementById("attendanceTable"); table.innerHTML="";
  let headerRow=`<tr><th>Employee</th>`;
  for(let d=1; d<=daysInMonth; d++){
    const date=new Date(year, monthNum-1,d);
    const day=date.toLocaleDateString("en-US",{weekday:"short"});
    headerRow+=`<th>${d}<br>${day}</th>`;
  }
  headerRow+="</tr>"; table.innerHTML=headerRow;

  const today = new Date(); today.setHours(0,0,0,0);

  employees.forEach(emp=>{
    let row=`<tr><td>${emp}</td>`;
    for(let d=1; d<=daysInMonth; d++){
      const date=new Date(year, monthNum-1,d);
      const key=`${emp}_${year}-${monthNum}-${d}`;
      let val=attendanceData[key]||"";
      if(date.getDay()===0||date.getDay()===6){ 
          row+=`<td class="weekend">Week Off</td>`; 
      } else if(date < today){ 
          row+=`<td style="background:${colors[val]||'transparent'}">${val||""}</td>`;
      } else { 
          row+=`<td style="background:${colors[val]||'transparent'}">
            <select onchange="updateData('${key}', this.value)">
              <option value="">Select</option>
              <option value="WFO" ${val==="WFO"?"selected":""}>WFO</option>
              <option value="WFH" ${val==="WFH"?"selected":""}>WFH</option>
              <option value="Leave" ${val==="Leave"?"selected":""}>Leave</option>
              <option value="Holiday" ${val==="Holiday"?"selected":""}>Holiday</option>
            </select>
          </td>`;
      }
    }
    row+="</tr>"; table.innerHTML+=row;
  });
  updateCharts();

  refreshEmployeeDatalist();

  const currentSearch = document.getElementById("employeeSearch")?.value?.trim();
  if(currentSearch) applyEmployeeFilter();
}

/* === Realtime writes (Firebase instead of localStorage) === */
function addEmployee(){ 
  const name=document.getElementById("employeeName").value.trim(); 
  if(!name) return;
  window._db.set( window._db.child(window._db.employeesRef, name), true )
    .then(()=>{ document.getElementById("employeeName").value=""; })
    .catch(console.error);
}
function removeEmployee(){ 
  const name=document.getElementById("employeeName").value.trim(); 
  if(!name) return;

  // remove from employees
  window._db.remove( window._db.child(window._db.employeesRef, name) );

  // remove that employeeâ€™s attendance keys
  const updates = {};
  Object.keys(attendanceData).forEach(k=>{
    if(k.startsWith(name + "_")) updates[k] = null;
  });
  if(Object.keys(updates).length){
    window._db.update(window._db.attendanceRef, updates);
  }
  document.getElementById("employeeName").value="";
}
function updateData(key,val){ 
  if(!val){
    window._db.remove( window._db.child(window._db.attendanceRef, key) );
  } else {
    window._db.set( window._db.child(window._db.attendanceRef, key), val );
  }
}
function applyBulkUpdate(){
  const status = document.getElementById("bulkStatus").value;
  const start  = parseInt(document.getElementById("bulkStart").value);
  const end    = parseInt(document.getElementById("bulkEnd").value);
  const monthVal = document.getElementById("monthPicker").value;
  if(!monthVal || isNaN(start) || isNaN(end)) return;

  const [year, monthNum] = monthVal.split("-");
  const today = new Date(); today.setHours(0,0,0,0);

  const updates = {};
  employees.forEach(emp=>{
    for(let d=start; d<=end; d++){
      const date = new Date(year, monthNum-1, d);
      if(date >= today){
        updates[`${emp}_${year}-${monthNum}-${d}`] = status;
      }
    }
  });
  if(Object.keys(updates).length){
    window._db.update(window._db.attendanceRef, updates).catch(console.error);
  }
}

/* Excel export keeps reading from attendanceData (which mirrors DB) */
function saveToExcel(){
  let ws_data = [["Employee","Date","Status"]];
  for(let key in attendanceData){
    let [emp,date] = key.split("_");
    ws_data.push([emp,date,attendanceData[key]]);
  }
  let ws = XLSX.utils.aoa_to_sheet(ws_data);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Attendance");
  XLSX.writeFile(wb, "Attendance.xlsx");
}

/* Excel import â†’ push to Firebase */
function loadFromExcel(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const tmpAttendance = {};
    const tmpEmployees = new Set();
    let firstDate = null;

    json.slice(1).forEach(row => {
      if(row.length >= 3){
        const [emp,date,val] = row;
        if(emp && date){
          tmpEmployees.add(emp);
          if(val) tmpAttendance[`${emp}_${date}`] = val;
          if(!firstDate) firstDate = date;
        }
      }
    });

    // Push employees
    if(tmpEmployees.size){
      const empUpdates = {};
      Array.from(tmpEmployees).forEach(e => empUpdates[e] = true);
      window._db.update(window._db.employeesRef, empUpdates);
    }

    // Push attendance
    if(Object.keys(tmpAttendance).length){
      window._db.update(window._db.attendanceRef, tmpAttendance);
    }

    if(firstDate){
      const [year, month] = String(firstDate).split("-"); 
      const monthInput = document.getElementById("monthPicker");
      if (year && month && monthInput) monthInput.value = `${year}-${String(month).padStart(2,'0')}`;
    }
  };
  reader.readAsArrayBuffer(file);
}

function toggleMonthlyView(){
  const monthlyToggle = document.getElementById("monthlyToggle").checked;
  document.getElementById("monthlyPicker").style.display = monthlyToggle ? "inline-block" : "none";
  document.getElementById("dayPicker").disabled = monthlyToggle;
  updateCharts();
}

/* === Gradient helpers === */
function createGradient(ctx, color){
  const gradient = ctx.createLinearGradient(0,0,0,350);
  gradient.addColorStop(0, lightenColor(color,0.3));
  gradient.addColorStop(1, color);
  return gradient;
}
function lightenColor(hex, lum) {
  hex = String(hex).replace(/[^0-9a-f]/gi, '');
  if(hex.length<6){ hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]; }
  let rgb="#", c, i;
  for(i=0;i<3;i++){ c=parseInt(hex.substr(i*2,2),16); c=Math.min(255,Math.max(0,c+Math.round(255*lum))).toString(16); while(c.length<2)c="0"+c; rgb+=c; }
  return rgb;
}

/* === Charts === */
function updateCharts(){
  const monthlyView = document.getElementById("monthlyToggle").checked;
  const selectedMonth = document.getElementById("monthlyPicker").value;
  const selectedDate = document.getElementById("dayPicker").value;

  let summary={}, employeeNames={};

  if(monthlyView && selectedMonth){
    const [year, monthNum] = selectedMonth.split("-");
    employees.forEach(emp=>{
      for(let d=1; d<=new Date(year, monthNum,0).getDate(); d++){
        const key = `${emp}_${year}-${monthNum}-${d}`;
        const val = attendanceData[key];
        if(colors[val]){
          summary[val]=(summary[val]||0)+1;
          employeeNames[val] = employeeNames[val] || [];
          if(!employeeNames[val].includes(emp)) employeeNames[val].push(emp);
        }
      }
    });
  } else if(selectedDate){
    employees.forEach(emp=>{
      const key=`${emp}_${selectedDate}`;
      const val=attendanceData[key];
      if(colors[val]){
        summary[val]=(summary[val]||0)+1;
        employeeNames[val] = employeeNames[val] || [];
        employeeNames[val].push(emp);
      }
    });
  }

  const ctxBar = document.getElementById("barChart").getContext("2d");
  const barData={labels:Object.keys(summary), datasets:[{
    data:Object.values(summary),
    backgroundColor: Object.keys(summary).map(k=>createGradient(ctxBar,colors[k])),
    borderRadius: 8
  }]};

  const commonLayout = { padding:{top:8,right:16,bottom:28,left:16} };

  const barOptions = { 
    responsive:true, 
    plugins:{ 
      legend:{ display:false },
      tooltip:{ 
        callbacks:{
          label:function(context){
            let val = context.label;
            let names = employeeNames[val] || [];
            return `${val}: ${context.raw}` + (names.length ? ` (${names.join(", ")})` : '');
          }
        }
      }
    },
    layout: commonLayout,
    scales:{ 
      y:{beginAtZero:true, grid:{color:"rgba(255,255,255,0.1)"}}, 
      x:{
        offset: true,
        ticks:{autoSkip:true,maxRotation:45,minRotation:0},
        grid:{color:"rgba(255,255,255,0.05)"}
      } 
    },
    maintainAspectRatio:false,
    animation: { duration:800, easing:'easeOutQuart' }
  };
  if(barChart) barChart.destroy();
  barChart=new Chart(ctxBar,{ type:"bar", data:barData, options:barOptions });

  const monthLabel = monthlyView && selectedMonth ? selectedMonth : document.getElementById("monthPicker").value;
  let monthSummary={};
  if(monthLabel){
    const [year, monthNum] = monthLabel.split("-");
    employees.forEach(emp=>{
      for(let d=1; d<=new Date(year, monthNum,0).getDate(); d++){
        const key = `${emp}_${year}-${monthNum}-${d}`;
        const val = attendanceData[key];
        if(!monthSummary[emp]) monthSummary[emp]={};
        monthSummary[emp][val]=(monthSummary[emp][val]||0)+1;
      }
    });
  }

  const statuses=["WFO","WFH","Leave","Holiday"];
  const ctxStacked = document.getElementById("stackedChart").getContext("2d");
  const datasets=statuses.map(s=>({ 
    label:s, 
    data: employees.map(emp => monthSummary[emp]?monthSummary[emp][s]||0:0), 
    backgroundColor:createGradient(ctxStacked,colors[s]), 
    borderRadius:8,
    maxBarThickness:40
  }));
  if(stackedChart) stackedChart.destroy();
  stackedChart=new Chart(ctxStacked,{
    type:"bar",
    data:{labels:employees,datasets},
    options:{
      responsive:true, 
      layout: commonLayout,
      plugins:{
        tooltip:{mode:"index"},
        legend:{
          onClick: function(e, legendItem, legend){
            const index = legendItem.datasetIndex;
            const ci = legend.chart;

            const alreadyIsolated = ci.data.datasets.every((ds, i) => 
              (i === index && ci.getDatasetMeta(i).hidden !== true) ||
              (i !== index && ci.getDatasetMeta(i).hidden === true)
            );
            const allHidden = ci.data.datasets.every((ds, i) => ci.getDatasetMeta(i).hidden === true);

            if (alreadyIsolated || allHidden) {
              ci.data.datasets.forEach((ds, i) => {
                ci.getDatasetMeta(i).hidden = false;
              });
            } else {
              ci.data.datasets.forEach((ds, i) => {
                ci.getDatasetMeta(i).hidden = i !== index;
              });
            }
            ci.update();
          }
        }
      },
      scales:{
        x:{
          stacked:true,
          offset: true,
          ticks:{autoSkip:true,maxRotation:45,minRotation:0},
          grid:{color:"rgba(255,255,255,0.05)"}
        }, 
        y:{stacked:true, beginAtZero:true, grid:{color:"rgba(255,255,255,0.1)"}}
      },
      maintainAspectRatio:false,
      animation:{ duration:800, easing:'easeOutQuart' }
    }
  });
}

/* ===== Realtime listeners â€” keep UI in sync across users ===== */
(function initRealtime(){
  // Employees
  window._db.onValue(window._db.employeesRef, (snap)=>{
    const val = snap.val() || {};
    employees = Object.keys(val);
    refreshEmployeeDatalist();
    generateTable();
  });

  // Attendance
  window._db.onValue(window._db.attendanceRef, (snap)=>{
    attendanceData = snap.val() || {};
    generateTable();
  });
})();

/* ===== UX niceties ===== */
document.getElementById("employeeSearch").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); applyEmployeeFilter(); }
});

/* Initialize defaults */
window.addEventListener("DOMContentLoaded", ()=>{
  const monthInput = document.getElementById("monthPicker");
  if(monthInput && !monthInput.value){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,'0');
    monthInput.value = `${yyyy}-${mm}`;
  }
  // Table will render/refresh as soon as Firebase listeners fire.
});
</script>
</body>
</html>
