<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Attendance Tracker (Patched)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase v9 modular SDK (CDN module). Initializes Firebase and exposes helpers to window.firebaseDB -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, update, push, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  // <-- YOUR firebaseConfig pasted here -->
  const firebaseConfig = {
    apiKey: "AIzaSyDjBqHpawIuc4RKQ3S-dnohCfjSwBvdkk4",
    authDomain: "attendence-tracker-28d8d.firebaseapp.com",
    databaseURL: "https://attendence-tracker-28d8d-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "attendence-tracker-28d8d",
    storageBucket: "attendence-tracker-28d8d.firebasestorage.app",
    messagingSenderId: "796356629335",
    appId: "1:796356629335:web:1be1c346036fff063a6412",
    measurementId: "G-FPRYP4FCXR"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // Try anonymous sign-in for a simple secure setup (you can remove if you don't want auth)
  signInAnonymously(auth).then(() => {
    console.log("Signed in anonymously to Firebase");
  }).catch(err => {
    console.warn("Anonymous sign-in failed (you can ignore this if you use open DB rules):", err);
  });

  // Expose DB helpers to non-module script below
  window.firebaseDB = { db, ref, set, get, onValue, update, push, child };
</script>

<style>
:root {
  --card-bg: rgba(30,30,30,0.6);
  --card-hover: rgba(45,45,45,0.85);
  --text-color: #f1f1f1;
  --neon-teal: #00b894;
  --neon-blue: #0984e3;
  --button-gradient: linear-gradient(90deg,#0984e3,#6c5ce7);
  --wfo-color: #2ecc71;
  --wfh-color: #3498db;
  --leave-color: #e74c3c;
  --holiday-color: #f1c40f;
}

* { box-sizing: border-box; }

body {
  font-family: 'Poppins', sans-serif;
  margin:0; padding:0;
  background: linear-gradient(-45deg, #0b132b, #1c2541, #3a506b, #5bc0be, #1e3c72, #6a11cb, #ff9a9e, #fbc531);
  background-size: 800% 800%;
  animation: galaxyShift 40s ease infinite;
  color: #000;
  overflow-x: hidden;
  position: relative;
  padding-top: 64px;
}
@keyframes galaxyShift {
  0%   { background-position:   0% 50%; }
  50%  { background-position: 100% 50%; }
  100% { background-position:   0% 50%; }
}

/* Overlay for readability */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  pointer-events: none;
  z-index: 0;
}

/* Starfield + particle canvases */
#stars-bg, #particles-bg {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
}

/* RGB Nebula â€” color-cycling background blob */
.rgb-nebula{
  position: fixed;
  inset: -15vmax;
  z-index: 0;
  filter: blur(80px) saturate(140%);
  opacity: .45;
  background:
    radial-gradient(40vmax 40vmax at 20% 30%, #ff0080 0%, transparent 60%),
    radial-gradient(35vmax 35vmax at 80% 20%, #00e5ff 0%, transparent 60%),
    radial-gradient(55vmax 55vmax at 50% 75%, #7cff00 0%, transparent 65%);
  animation: nebulaDrift 28s ease-in-out infinite alternate,
             hueCycle 18s linear infinite;
  pointer-events:none;
}
@keyframes nebulaDrift {
  0%   { transform: translate3d(-2vmax,-1vmax,0) scale(1); }
  100% { transform: translate3d( 2vmax, 1vmax,0) scale(1.05); }
}
@keyframes hueCycle { to { filter: hue-rotate(360deg) blur(80px) saturate(140%); } }

header {
  text-align: center;
  font-size: 3em;
  font-weight: 700;
  padding: 25px;
  margin-bottom: 20px;
  position: relative;
  z-index: 1;
  background: linear-gradient(90deg, #fff, #00b894, #0984e3, #fff);
  background-size: 300% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: shimmer 8s infinite linear;
}
@keyframes shimmer {
  0% { background-position: 0% 50%; }
  100% { background-position: 300% 50%; }
}

/* Glass Topbar styles (replaced previous topbar) */
.topbar {
  position: fixed;
  left: 12px;
  right: 12px;
  top: 10px;
  z-index: 9999;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 16px;
  pointer-events: auto;
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(10,12,16,0.42), rgba(8,10,12,0.30));
  backdrop-filter: blur(10px) saturate(120%);
  -webkit-backdrop-filter: blur(10px) saturate(120%);
  border: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 10px 30px rgba(8,12,20,0.55), 0 1px 0 rgba(255,255,255,0.02) inset;
}

/* allow children to accept clicks while topbar container ignores pointer events */
.topbar > * { pointer-events: auto; }

 /* Live IST clock (pinned left) */
.clock {
  color: #f1f1f1;
  font-weight: 600;
  letter-spacing: .3px;
  padding: 6px 10px;
  border-radius: 10px;
  background: linear-gradient(90deg, rgba(20,20,20,0.9), rgba(12,12,12,0.95));
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 8px 20px rgba(0,0,0,0.45), 0 0 10px rgba(9,132,227,0.08) inset;
  text-shadow: 0 0 8px rgba(9,132,227,0.45);
  font-size: 0.96rem;
  margin-right: 6px;
}

/* User panel pinned to right (via spacer in HTML) */
.user-panel {
  display:flex;
  gap:10px;
  align-items:center;
  background: linear-gradient(90deg, rgba(10,10,12,0.7), rgba(6,6,8,0.75));
  padding: 6px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 6px 18px rgba(0,0,0,0.45);
}
.user-badge {
  padding: 6px 12px;
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(9,132,227,0.12), rgba(0,184,148,0.06));
  color: #fff;
  font-weight: 600;
  font-size: 0.92rem;
  display:flex; gap:8px; align-items:center;
}
.user-actions button {
  padding:6px 10px;
  border-radius: 12px;
  border: none;
  background: rgba(255,255,255,0.06);
  color: #fff;
  cursor:pointer;
  font-weight:600;
  transition: transform .12s, box-shadow .12s;
}
.user-actions button:hover{ transform: translateY(-2px); box-shadow: 0 6px 14px rgba(0,0,0,0.35); }

.container {
  display:flex; flex-direction:column; gap:25px; padding:20px; max-width:1200px; margin:auto;
  position: relative;
  z-index: 1;
}

.card {
  background: var(--card-bg);
  border-radius:20px;
  padding:25px;
  color: var(--text-color);
  backdrop-filter: blur(15px);
  transition: transform 0.4s ease, box-shadow 0.4s ease, background 0.4s ease;
  border: 1px solid transparent;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    0 14px 28px rgba(0,0,0,.35);
  position: relative;
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.8s ease forwards;
}
.card:hover { 
  background: var(--card-hover);
  transform: translateY(-8px);
  box-shadow: 0 22px 50px rgba(0,0,0,.48);
}
.card::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 20px;
  padding: 2px;
  background: linear-gradient(135deg, #0984e3, #6c5ce7, #00b894);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
          mask-composite: exclude;
  pointer-events: none;
  box-shadow:
    0 0 18px rgba(9,132,227,.28),
    0 0 26px rgba(0,184,148,.18);
}
.card::after{
  content:"";
  position:absolute;
  inset:10px -8px -8px -8px;
  border-radius:22px;
  background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
  filter: blur(10px);
  z-index:-1;
  pointer-events:none;
}

@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

.section-title {
  font-size:1.6em; margin-bottom:15px; font-weight:600;
  border-bottom:1px solid rgba(255,255,255,0.2);
  padding-bottom:8px; letter-spacing:0.5px;
  color: var(--neon-blue);
  text-shadow: 0 0 8px rgba(9,132,227,0.8), 0 0 15px rgba(9,132,227,0.5);
  position: relative;
}
.section-title::after{
  content:"";
  position:absolute; left:0; right:0; bottom:-2px; height:2px;
  background: linear-gradient(90deg, #ff3b3b, #ffd93b, #3bff7c, #3bbdff, #9d3bff, #ff3bcb);
  background-size: 300% 100%;
  animation: lineShift 10s linear infinite;
  opacity:.85;
}
@keyframes lineShift{ to { background-position: 300% 0; } }

input, #monthPicker, #dayPicker, #monthlyPicker, #fileInput, select {
  padding:10px 18px; border-radius:25px; border:1px solid #555; outline:none; transition: all 0.3s ease; width:220px;
  color:#f1f1f1; background: rgba(0,0,0,0.6);
  font-weight:500;
}
input:focus, #monthPicker:focus, #dayPicker:focus, #monthlyPicker:focus, #fileInput:focus, select:focus {
  box-shadow:0 0 12px var(--neon-teal);
  transform:scale(1.05);
}

select:hover {
  border-color: var(--neon-blue);
  box-shadow: 0 0 8px var(--neon-blue);
}

select option[value="WFO"] { background-color: var(--card-bg); color: var(--wfo-color); }
select option[value="WFH"] { background-color: var(--card-bg); color: var(--wfh-color); }
select option[value="Leave"] { background-color: var(--card-bg); color: var(--leave-color); }
select option[value="Holiday"] { background-color: var(--card-bg); color: var(--holiday-color); }

button {
  padding:10px 22px; border:none; border-radius:25px; cursor:pointer; margin:4px;
  background: var(--button-gradient);
  color:white; font-weight:bold; transition:0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
button:hover { 
  filter: brightness(1.2); 
  transform: scale(1.08);
  box-shadow: 0 0 12px var(--neon-blue), 0 0 18px var(--neon-teal);
}

/* Table */
.table-wrapper { overflow-x: auto; max-width: 100%; isolation: isolate; } 
.table-container { display: inline-block; }

.card.table-card,
.card.table-card:hover {
  background: #141414;  
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    0 14px 28px rgba(0,0,0,.35);
}

table {
  border-collapse: collapse;
  min-width: 800px;
  background: rgba(0,0,0,0.65);
  color: #f1f1f1;
}

th, td {
  border:1px solid rgba(255,255,255,0.2);
  padding:10px;
  text-align:center;
  white-space:nowrap;
}
th {
  background: rgba(20,20,20,0.95);
  position: sticky;
  top: 0;
  z-index: 3;
}

td:first-child,
th:first-child{
  position: sticky;
  left: 0;
  background: #141414;     
  z-index: 10;
  transform: translateZ(0);
  will-change: transform;
  box-shadow: 6px 0 8px rgba(0,0,0,0.35); 
}
th:first-child{ z-index: 11; }

table tr:hover td:not(.weekend):not(:first-child) {
  background: rgba(255,255,255,0.15);
  box-shadow: inset 0 0 8px rgba(9,132,227,0.5);
  transition: 0.25s;
}

table tr:nth-child(even) td { background: rgba(255,255,255,0.05); }
.weekend { background: rgba(50,50,50,0.5); color:#bbb; pointer-events:none; }

/* NEW: very noticeable highlight for selected date cells */
@keyframes pulseGlow {
  0% { box-shadow: 0 10px 30px rgba(255,255,255,0.06), 0 0 0 rgba(0,0,0,0); transform: translateY(0); }
  50% { box-shadow: 0 18px 40px rgba(255,255,255,0.09), 0 0 18px rgba(255,255,255,0.06); transform: translateY(-2px); }
  100% { box-shadow: 0 10px 30px rgba(255,255,255,0.06), 0 0 0 rgba(0,0,0,0); transform: translateY(0); }
}
.date-highlight {
  border-radius: 8px;
  padding: 6px 8px;
  outline: 4px solid rgba(255,255,255,0.12);
  box-shadow: 0 18px 40px rgba(9,132,227,0.12), inset 0 -6px 18px rgba(255,255,255,0.02);
  animation: pulseGlow 1.6s ease-in-out infinite;
  transform-origin: center;
  transition: transform .12s, box-shadow .12s;
}

/* when a date cell is highlighted, slightly darken its background for contrast */
.date-highlight[data-status="WFO"] { background: rgba(46,204,113,0.18); }
.date-highlight[data-status="WFH"] { background: rgba(52,152,219,0.14); }
.date-highlight[data-status="Leave"] { background: rgba(231,76,60,0.14); }
.date-highlight[data-status="Holiday"] { background: rgba(241,196,15,0.14); }

.charts { display: flex; justify-content: space-between; gap: 20px; flex-wrap: nowrap; }
.chart-container { 
  flex:1; height:380px; border-radius:18px; padding:20px; 
  background: rgba(20,20,20,0.55); 
  display:flex; flex-direction: column; 
  box-shadow:
    0 12px 28px rgba(0,0,0,.42),
    0 0 24px rgba(9,132,227,.16) inset;
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.15);
  overflow: hidden; /* keep original feel */
}
.chart-title { text-align:center; font-weight:700; font-size:1.4em; margin-bottom:12px; color:#f1f1f1; }

input[type="month"]::-webkit-calendar-picker-indicator,
input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1);
  cursor: pointer;
}

/* Overlay (login gate) */
#authOverlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display:flex;
  align-items:center;
  justify-content:center;
  background: linear-gradient(180deg, rgba(2,6,20,0.96), rgba(4,8,16,0.96));
  padding: 18px;
}
.authBox {
  width: 920px; max-width: 98%; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
  background: rgba(20,20,20,0.95); border-radius:12px; padding:18px; color:#f1f1f1;
  box-shadow: 0 14px 40px rgba(0,0,0,0.6);
  border: 1px solid rgba(255,255,255,0.04);
  position: relative;
  overflow: visible;
}
.authBox::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 12px;
  padding: 2px;
  background: linear-gradient(135deg, #0984e3, #6c5ce7, #00b894);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
          mask-composite: exclude;
  pointer-events: none;
  box-shadow:
    0 0 18px rgba(9,132,227,.28),
    0 0 26px rgba(0,184,148,.18);
}
.authBox h3 { margin: 0 0 8px 0; color: var(--neon-blue); }
.authRow { display:flex; flex-direction:column; gap:8px; }
.authHint { font-size:13px; color:#9aa8bf; margin-top:8px; }

.highlight-row { box-shadow: inset 0 0 0 2px rgba(9,132,227,0.6); }

.locked { filter: blur(2px) grayscale(.04); pointer-events: none; user-select: none; opacity: .98 }

@media (max-width: 760px){
  .topbar { padding: 0 10px; }
  .clock { font-size:0.8rem; padding:6px 8px; }
  .user-badge { font-size:0.85rem; padding:4px 8px; }
}

/* Small view toggle style inside Visualizations to match theme */
.view-toggle {
  display:inline-flex; gap:8px; align-items:center; margin-bottom:12px;
}
.view-toggle .pill {
  background: rgba(255,255,255,0.03);
  border-radius: 999px;
  padding: 6px;
  display: inline-flex;
}
.view-toggle .pill button {
  background: transparent; border: none; color: #d6eefc; padding: 8px 12px; border-radius:999px; cursor:pointer; font-weight:700;
}
.view-toggle .pill button.active {
  background: linear-gradient(90deg,#0984e3,#6c5ce7);
  box-shadow: 0 8px 18px rgba(9,132,227,0.12);
}

/* --- TOP reserved bar spacer (added) --- */
.top-reserved {
  height: 10px;
  width: 100%;
  pointer-events: none;
}

/* ===== Capsule badges for search summary (below search bar) ===== */
.capsule-badges {
  display:flex;
  gap:12px;
  margin-top:10px;
  flex-wrap:wrap;
  align-items:center;
}
.capsule-badges .badge {
  padding:8px 14px;
  border-radius:999px;
  font-weight:700;
  color:#111;
  box-shadow: 0 6px 18px rgba(0,0,0,0.38);
  min-width:88px;
  text-align:center;
  display:inline-block;
  cursor:pointer;
  user-select:none;
  transition: transform .12s, box-shadow .12s;
}
.capsule-badges .badge:hover { transform: translateY(-3px); box-shadow: 0 10px 26px rgba(0,0,0,0.45); }
.capsule-badges .badge.active {
  outline: 3px solid rgba(255,255,255,0.08);
  transform: scale(1.03);
}

/* Make sure Attendance table's search summary area doesn't break layout */
.search-card { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
.search-card .mini-title { color:#dbeffd; font-weight:700; margin-right:6px; }
#searchSummary { margin-left:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; max-width:calc(100% - 220px); }

/* small selected employees list */
.selected-list {
  display:flex; gap:8px; flex-wrap:wrap; margin-left:8px; align-items:center;
}
.selected-list .sel {
  padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.04); color:#dbeffd; font-weight:700; cursor:default;
}

/* === Horizontal scroller for combined chart === */
#chartScroller { 
  width: 100%;
  overflow-x: auto;
  overflow-y: hidden;
}
</style>
</head>
<body>

<!-- Top reserved bar (added) -->
<div class="top-reserved" aria-hidden="true"></div>

<!-- Topbar: clock (left) + spacer + user panel (right) -->
<div class="topbar" aria-hidden="false">
  <div id="clock" class="clock">--:--:-- -- | -- --- ----</div>

  <div style="flex:1"></div> <!-- spacer pushes user panel to the far right -->

  <div class="user-panel" id="topUserPanel" aria-hidden="false">
    <div class="user-badge" id="userStatusDisplay">Not logged</div>
    <div class="user-actions" id="topUserActions">
      <button id="userLogoutBtn" style="display:none">Logout</button>
      <button id="adminLoginMainBtn">Admin Login</button>
      <button id="adminLogoutMainBtn" style="display:none">Admin Logout</button>
    </div>
  </div>
</div>

<!-- Twinkling stars & particle network -->
<canvas id="stars-bg"></canvas>
<canvas id="particles-bg"></canvas>

<!-- RGB Nebula layer -->
<div class="rgb-nebula" aria-hidden="true"></div>

<header>Data Transformers</header>

<!-- AUTH OVERLAY (gate) -->
<div id="authOverlay" role="dialog" aria-modal="true">
  <div class="authBox">
    <div class="authLeft authRow">
      <h3>User Login / Register</h3>
      <label for="gateUserName">Name</label>
      <input id="gateUserName" type="text" placeholder="e.g. Ravi Kumar" autocomplete="off">

      <label for="gateUserPwd">Password</label>
      <input id="gateUserPwd" type="password" placeholder="Choose / enter password">

      <div style="display:flex; gap:10px; margin-top:8px;">
        <button id="gateRegisterBtn">Register</button>
        <button id="gateUserLoginBtn">Login</button>
      </div>

      <div class="authHint">Register will create your user account and add you to employees so your row appears.</div>
    </div>

    <div class="authRight authRow">
      <h3>Admin Login</h3>
      <label for="gateAdminPwd">Admin password</label>
      <input id="gateAdminPwd" type="password" placeholder="Admin password">

      <div style="display:flex; gap:10px; margin-top:8px;">
        <button id="gateAdminLoginBtn">Admin Login</button>
        <button id="gateSkipBtn" title="Restore session if stored">Restore session / Cancel</button>
      </div>

      <div class="authHint">If you've logged in previously, press Restore session; otherwise login/register.</div>
    </div>
  </div>
</div>

<div id="mainPage" class="locked">

  <div class="container">

    <!-- Admin: Employee Management -->
    <div class="card" id="adminCard" style="display:none">
      <div class="section-title">Employee Management</div>
      <div id="employeeList">
        <input type="text" id="employeeName" placeholder="Enter employee name">
        <button id="addEmployeeBtn">Add</button>
        <button id="removeEmployeeBtn">Remove</button>
      </div>
    </div>

    <!-- TABLE CARD -- visible to users and admin -->
    <div class="card table-card">
      <div class="section-title">Attendance Table</div>

      <div class="search-card">
        <span class="mini-title">Search Employee Presence:</span>
        <input type="text" id="employeeSearch" list="employeeSuggestions" placeholder="Type employee name..." />
        <datalist id="employeeSuggestions"></datalist>
        <button id="searchBtn">Add</button>
        <button id="clearSearchBtn">Clear</button>

        <!-- selected employees pills -->
        <div class="selected-list" id="selectedList" aria-live="polite"></div>

        <!-- badges will be rendered here (under search) -->
        <div id="searchSummary"></div>
      </div>

      <label for="monthPicker">Select Month for Table: </label>
      <input type="month" id="monthPicker" onchange="generateTable()">
      <div class="table-wrapper">
        <div class="table-container">
          <table id="attendanceTable"></table>
        </div>
      </div>
    </div>

    <!-- Admin: Bulk Update (admin-only) -->
    <div class="card" id="bulkCard" style="display:none">
      <div class="section-title">Bulk Update Attendance</div>
      <label>Status: </label>
      <select id="bulkStatus">
        <option value="WFO">WFO</option>
        <option value="WFH">WFH</option>
        <option value="Leave">Leave</option>
        <option value="Holiday">Holiday</option>
      </select>
      <label>Start Day: </label>
      <input type="number" id="bulkStart" min="1" max="31">
      <label>End Day: </label>
      <input type="number" id="bulkEnd" min="1" max="31">
      <button id="bulkApplyBtn">Apply</button>
    </div>

    <!-- Admin: Save / Upload Data -->
    <div class="card" id="saveUploadCard" style="display:none">
      <div class="section-title">Save / Upload Data</div>
      <button id="saveExcelBtn">SAVE FILE</button>
      <button id="uploadFileBtn">UPLOAD FILE</button>
      <input type="file" id="fileInput" accept=".xlsx" style="display:none">
    </div>

    <!-- Visualizations (now single combined chart; visible to all users) -->
    <div class="card" id="vizCard" style="display:none">
      <div class="section-title">Visualizations</div>

      <div class="view-toggle" role="group" aria-label="Daily or Monthly view toggle">
        <div class="pill" id="vizPill">
          <button id="vizDailyBtn" type="button">Daily</button>
          <button id="vizMonthlyBtn" class="active" type="button">Monthly</button>
        </div>
        <div style="margin-left:12px; color:#dbeffd; font-weight:600;">Switch chart scope</div>
      </div>

      <input type="month" id="monthlyPicker" style="display:inline-block; margin-left:20px;" onchange="updateCharts()">
      <label for="dayPicker" style="margin-left:20px;">Select Day: </label>
      <input type="date" id="dayPicker" onchange="updateCharts()" disabled>

      <div class="charts" style="margin-top:15px;">
        <div class="chart-container">
          <div class="chart-title" id="combinedChartTitle">Monthly Summary</div>
          <div id="chartScroller">
            <canvas id="combinedChart"></canvas>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ===== app state & helpers ===== */
const SESSION_USER_KEY = 'attendance_current_user';
const SESSION_ADMIN_KEY = 'attendance_is_admin';

let employees = [], attendanceData = {}, barChart=null; // single chart now
/* color map */
const colors = {"WFO":"#2ecc71","WFH":"#3498db","Leave":"#e74c3c","Holiday":"#f1c40f"};

/* selection state: multiple employees */
let selectedEmployees = [];

let firebaseSynced = false; // <- guard: we received initial server snapshot
const TOP_N = 10; // show first N employees by default; rest horizontally scrollable

function encodeKey(key){ return encodeURIComponent(key); }
function decodeKey(enc){ try{ return decodeURIComponent(enc); } catch(e){ return enc; } }
function dbReady(){ return !!window.firebaseDB && !!window.firebaseDB.db; }

/* SHA-256 hex */
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const hashBuf = await crypto.subtle.digest('SHA-256', enc);
  const hashArray = Array.from(new Uint8Array(hashBuf));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

/* UI refs */
const overlay = document.getElementById('authOverlay');
const mainPage = document.getElementById('mainPage');
const gateUserName = document.getElementById('gateUserName');
const gateUserPwd = document.getElementById('gateUserPwd');
const gateRegisterBtn = document.getElementById('gateRegisterBtn');
const gateUserLoginBtn = document.getElementById('gateUserLoginBtn');
const gateAdminPwd = document.getElementById('gateAdminPwd');
const gateAdminLoginBtn = document.getElementById('gateAdminLoginBtn');
const gateSkipBtn = document.getElementById('gateSkipBtn');

const addEmployeeBtn = document.getElementById('addEmployeeBtn');
const removeEmployeeBtn = document.getElementById('removeEmployeeBtn');
const searchBtn = document.getElementById('searchBtn');
const clearSearchBtn = document.getElementById('clearSearchBtn');
const saveExcelBtn = document.getElementById('saveExcelBtn');
const uploadFileBtn = document.getElementById('uploadFileBtn');
const fileInput = document.getElementById('fileInput');
const bulkApplyBtn = document.getElementById('bulkApplyBtn');
const adminLoginMainBtn = document.getElementById('adminLoginMainBtn');
const adminLogoutMainBtn = document.getElementById('adminLogoutMainBtn');
const userLogoutBtn = document.getElementById('userLogoutBtn');
const userStatusDisplay = document.getElementById('userStatusDisplay');
const adminCardEl = document.getElementById('adminCard');
const saveUploadCardEl = document.getElementById('saveUploadCard');
const bulkCardEl = document.getElementById('bulkCard');
const vizCardEl = document.getElementById('vizCard');

const selectedListEl = document.getElementById('selectedList');
const searchSummaryEl = document.getElementById('searchSummary');

if(typeof window.currentUser === 'undefined') window.currentUser = null;
if(typeof window.isAdmin === 'undefined') window.isAdmin = false;

/* show/hide overlay */
function showOverlay(){ overlay.style.display = 'flex'; mainPage.classList.add('locked'); }
function hideOverlay(){ overlay.style.display = 'none'; mainPage.classList.remove('locked'); }

/* update session UI */
function updateSessionUI(){
  userStatusDisplay.textContent = window.currentUser ? `Logged in: ${window.currentUser}` : 'Not logged';
  userLogoutBtn.style.display = window.currentUser ? '' : 'none';

  // Admin-specific panels
  if(window.isAdmin){
    adminLoginMainBtn.style.display = 'none';
    adminLogoutMainBtn.style.display = '';
    if(adminCardEl) adminCardEl.style.display = 'block';
    if(saveUploadCardEl) saveUploadCardEl.style.display = '';           // show save/upload
    if(bulkCardEl) bulkCardEl.style.display = 'block';
  } else {
    adminLoginMainBtn.style.display = '';
    adminLogoutMainBtn.style.display = 'none';
    if(adminCardEl) adminCardEl.style.display = 'none';
    if(saveUploadCardEl) saveUploadCardEl.style.display = 'none';       // hide save/upload
    if(bulkCardEl) bulkCardEl.style.display = 'none';
  }

  // Visualization is visible to everyone (users and admin)
  if(vizCardEl) vizCardEl.style.display = 'block';
}

/* little alert */
function toast(msg){ alert(msg); }

/* ===== IST Clock (robust) ===== */
(function istClock(){
  const el = document.getElementById('clock');
  function tick(){
    try{
      const now = new Date();
      const fmtTime = new Intl.DateTimeFormat('en-IN',{
        timeZone:'Asia/Kolkata', hour:'numeric', minute:'2-digit', second:'2-digit', hour12:true
      }).format(now);
      const fmtDate = new Intl.DateTimeFormat('en-IN',{
        timeZone:'Asia/Kolkata', weekday:'short', day:'2-digit', month:'short', year:'numeric'
      }).format(now);
      if(el) el.textContent = `${fmtTime} | ${fmtDate}`;
    }catch(e){
      if(el) el.textContent = new Date().toLocaleString();
      console.warn('Clock update error', e);
    }
  }
  tick();
  setInterval(tick, 1000);
})();

/* ===== Firebase realtime listener ===== */
(function initFirebaseListener(){
  const waitForFirebase = () => {
    if(window.firebaseDB && window.firebaseDB.onValue){
      const { db, ref, onValue } = window.firebaseDB;
      const rootRef = ref(db, 'attendanceApp');
      onValue(rootRef, snapshot => {
        const val = snapshot.val();
        if(!val){
          attendanceData = {};
          employees = [];
        } else {
          attendanceData = {};
          const raw = val.attendanceData || {};
          for(const encKey in raw){
            attendanceData[ decodeKey(encKey) ] = raw[encKey];
          }
          employees = val.employees || [];
        }
        // mark that we've received the initial server snapshot
        firebaseSynced = true;
        refreshEmployeeDatalist();
        if(overlay.style.display === 'none') generateTable();
      }, err => {
        console.error("Firebase onValue err:", err);
      });
    } else {
      setTimeout(waitForFirebase, 200);
    }
  };
  waitForFirebase();
})();

/* ===== Save helpers ===== */
async function saveToFirebase(){
  if(!dbReady()){ console.warn('firebase not ready'); return; }
  const { db, ref, update, child, get } = window.firebaseDB;

  // Prepare encoded local state
  const encodedLocal = {};
  for(const k in attendanceData){
    encodedLocal[ encodeKey(k) ] = attendanceData[k];
  }

  try{
    let toWriteAttendance = encodedLocal;
    let toWriteEmployees = employees;

    if(!firebaseSynced){
      // Merge server first to avoid clobbering existing data with empty local
      const rootRef = ref(db, 'attendanceApp');
      const snap = await get(rootRef);
      const server = snap.exists() ? snap.val() : {};

      // attendanceData merge: server + local (local overwrites specific keys it knows)
      const serverAttendance = server.attendanceData || {};
      toWriteAttendance = { ...serverAttendance, ...encodedLocal };

      // employees merge (union)
      const serverEmployees = Array.isArray(server.employees) ? server.employees : [];
      const setUnion = new Set([ ...serverEmployees, ...employees ]);
      toWriteEmployees = Array.from(setUnion).sort((a,b)=>a.localeCompare(b));
    }

    await update(ref(db), {
      'attendanceApp/attendanceData': toWriteAttendance,
      'attendanceApp/employees': toWriteEmployees
    });
  } catch(err){
    console.error("Firebase update error:", err);
  }
}

/* Save only employees (used while registering/removing to avoid touching attendanceData) - MERGE SAFE */
async function saveEmployeesOnly(){
  if(!dbReady()){ console.warn('firebase not ready'); return; }
  const { db, ref, child, get, update } = window.firebaseDB;
  try {
    const rootRef = ref(db, 'attendanceApp');
    const snap = await get(child(rootRef, 'employees'));
    const serverEmployees = Array.isArray(snap.val()) ? snap.val() : [];
    const merged = Array.from(new Set([ ...serverEmployees, ...employees ])).sort((a,b)=>a.localeCompare(b));
    await update(rootRef, { employees: merged });
    employees = merged;
  } catch(err) {
    console.error("saveEmployeesOnly (merged) error:", err);
  }
}

/* ===== Single update with guard ===== */
function updateData(key, val){
  const namePart = key.split('_')[0];
  const current = window.currentUser || null;
  if(!window.isAdmin && (!current || namePart !== current)){
    alert('Permission denied: only the logged-in user or admin can modify this record.');
    generateTable();
    return;
  }

  attendanceData[key] = val;

  if(window.firebaseDB){
    const { db, ref, set } = window.firebaseDB;
    const safeKey = encodeKey(key);
    const valueToSet = (val === "" || val === null || typeof val === 'undefined') ? null : val;
    set(ref(db, `attendanceApp/attendanceData/${safeKey}`), valueToSet)
      .catch(err => console.error("Firebase single-key update failed:", err));
  } else {
    console.warn("firebaseDB not available; local-only update performed.");
  }
  generateTable();
}

/* ===== Admin flows ===== */
function setAdmin(state){
  window.isAdmin = !!state;
  if(window.isAdmin) localStorage.setItem(SESSION_ADMIN_KEY,'1');
  else localStorage.removeItem(SESSION_ADMIN_KEY);
  updateSessionUI();
}

function adminLoginFromOverlay(){
  const pwd = document.getElementById('gateAdminPwd').value || '';
  if(!pwd) return toast('Enter admin password.');
  if(!dbReady()) return toast('Firebase not ready.');
  const { db, ref, child, get } = window.firebaseDB;
  get(child(ref(db), 'attendanceApp/adminPassword')).then(snap=>{
    const stored = snap.exists() ? snap.val() : null;
    if(stored && String(stored) === String(pwd)){
      setAdmin(true);
      hideOverlay();
      generateTable();
      toast('Admin login success.');
    } else {
      toast('Invalid admin password.');
    }
  }).catch(e=>{ console.error(e); toast('Could not verify admin password (see console).'); });
}
function adminLoginFromMain(){ showOverlay(); document.getElementById('gateAdminPwd').focus(); }
function adminLogoutFromMain(){ setAdmin(false); showOverlay(); toast('Admin logged out.'); }

/* ===== User register/login (overlay) ===== */
function encodeUserKey(name){ return encodeURIComponent(name.trim().toLowerCase()); }

async function registerUserOverlay(){
  const name = (gateUserName.value||'').trim();
  const pwd = gateUserPwd.value||'';
  if(!name || !pwd) return toast('Enter name & password to register.');
  if(!dbReady()) return toast('DB not ready.');

  const { db, ref, child, get, set } = window.firebaseDB;
  const userRef = child(ref(db), `attendanceApp/users/${encodeUserKey(name)}`);
  try {
    const snap = await get(userRef);
    if(snap.exists()) return toast('User exists â€” please login instead.');
    const hash = await sha256Hex(pwd);
    await set(userRef, { name, passwordHash: hash });

    // add employee only to employees list (avoid touching attendanceData)
    if(!employees.includes(name)){
      employees.push(name);
      // NEW: use merge-safe employees write
      await saveEmployeesOnly();
    }

    window.currentUser = name;
    localStorage.setItem(SESSION_USER_KEY, name);
    updateSessionUI();
    hideOverlay();
    generateTable();
    toast('Registered and logged in.');
  } catch(e){
    console.error('register overlay err', e);
    toast('Registration failed (see console).');
  }
}

async function loginUserOverlay(){
  const name = (gateUserName.value || '').trim();
  const pwd = gateUserPwd.value || '';
  if(!name || !pwd) return toast('Enter name & password to login.');
  if(!dbReady()) return toast('DB not ready.');

  const { db, ref, child, get } = window.firebaseDB;
  const userRef = child(ref(db), `attendanceApp/users/${encodeUserKey(name)}`);
  try {
    const snap = await get(userRef);
    if(!snap.exists()) return toast('User not found. Use Register if you are new.');
    const rec = snap.val();
    const hash = await sha256Hex(pwd);
    if(String(hash) !== String(rec.passwordHash)) return toast('Invalid password.');

    window.currentUser = rec.name;
    localStorage.setItem(SESSION_USER_KEY, rec.name);
    updateSessionUI();
    hideOverlay();
    generateTable();
    toast('Login successful.');
  } catch(e){
    console.error('login overlay err', e);
    toast('Login failed (see console).');
  }
}

/* Restore session via Skip button */
function restoreSessionFromStorage(){
  const storedUser = localStorage.getItem(SESSION_USER_KEY);
  const storedAdmin = localStorage.getItem(SESSION_ADMIN_KEY);
  if(storedUser){ window.currentUser = storedUser; }
  if(storedAdmin){ window.isAdmin = true; }
  updateSessionUI();
  if(window.currentUser || window.isAdmin){
    hideOverlay();
    generateTable();
    return true;
  }
  return false;
}

/* Wire overlay buttons */
document.getElementById('gateRegisterBtn').addEventListener('click', registerUserOverlay);
document.getElementById('gateUserLoginBtn').addEventListener('click', loginUserOverlay);
document.getElementById('gateAdminLoginBtn').addEventListener('click', adminLoginFromOverlay);
document.getElementById('gateSkipBtn').addEventListener('click', () => {
  if(!restoreSessionFromStorage()) toast('No session found â€” please login or register.');
});

/* ===== Main UI wiring ===== */
document.getElementById('addEmployeeBtn')?.addEventListener('click', async ()=>{ 
  if(!window.isAdmin){ alert("Admin access required to add employees."); return; }
  const name=document.getElementById("employeeName").value.trim(); 
  if(name && !employees.includes(name)){ 
    employees.push(name); 
    document.getElementById("employeeName").value=""; 
    // only save employees list (avoid touching attendanceData) - use merge-safe writer
    await saveEmployeesOnly();
    refreshEmployeeDatalist();
    generateTable(); 
  } 
});
document.getElementById('removeEmployeeBtn')?.addEventListener('click', async ()=>{ 
  if(!window.isAdmin){ alert("Admin access required to remove employees."); return; }
  const name=document.getElementById("employeeName").value.trim();
  employees = employees.filter(e=>e!==name); 
  document.getElementById("employeeName").value=""; 
  await saveEmployeesOnly();
  refreshEmployeeDatalist();
  generateTable(); 
});
searchBtn.addEventListener('click', addEmployeeFromSearch);
document.getElementById('clearSearchBtn').addEventListener('click', clearEmployeeFilter);
document.getElementById('saveExcelBtn').addEventListener('click', saveToExcel);
document.getElementById('uploadFileBtn').addEventListener('click', ()=> {
  if(!window.isAdmin){
    alert("Admin access required to upload attendance data.");
    return;
  }
  fileInput.click();
});
fileInput.addEventListener('change', loadFromExcel);
document.getElementById('bulkApplyBtn')?.addEventListener('click', applyBulkUpdate);
adminLoginMainBtn.addEventListener('click', adminLoginFromMain);
adminLogoutMainBtn.addEventListener('click', adminLogoutFromMain);
userLogoutBtn.addEventListener('click', ()=> {
  localStorage.removeItem(SESSION_USER_KEY);
  window.currentUser = null;
  updateSessionUI();
  showOverlay();
  toast('User logged out.');
});

/* ===== Datalist & Search (user-limited visibility) ===== */
function refreshEmployeeDatalist(){
  const dl = document.getElementById("employeeSuggestions");
  if(!dl) return;
  dl.innerHTML = "";
  const listToShow = window.isAdmin ? employees.slice().sort((a,b)=>a.localeCompare(b)) : (window.currentUser ? [window.currentUser] : []);
  listToShow.forEach(emp=>{
    const opt = document.createElement("option");
    opt.value = emp;
    dl.appendChild(opt);
  });
}

/* Add employee to current selection (multiple select behavior) */
function addEmployeeFromSearch(){
  const input = document.getElementById("employeeSearch");
  const nameRaw = (input.value || '').trim();
  if(!nameRaw){ toast('Type an employee name to add.'); return; }

  const available = window.isAdmin ? employees : (window.currentUser ? [window.currentUser] : []);
  let match = available.find(e => e.toLowerCase() === nameRaw.toLowerCase());
  if(!match){
    match = available.find(e => e.toLowerCase().startsWith(nameRaw.toLowerCase())) ||
            available.find(e => e.toLowerCase().includes(nameRaw.toLowerCase()));
  }
  if(!match){ toast('No matching employee available to add.'); return; }

  if(!selectedEmployees.includes(match)){
    selectedEmployees.push(match);
    renderSelectedList();
    applySelectionToTable();
    updateSearchSummaryForSelection();
    input.value = '';
    input.focus();
  } else {
    toast(`${match} already selected.`);
    input.value = '';
    input.focus();
  }
}

/* render the selected employees pills */
function renderSelectedList(){
  selectedListEl.innerHTML = '';
  selectedEmployees.forEach(emp => {
    const span = document.createElement('div');
    span.className = 'sel';
    span.textContent = emp;
    span.title = 'Click to remove';
    span.style.cursor = 'pointer';
    span.addEventListener('click', ()=> {
      selectedEmployees = selectedEmployees.filter(e => e !== emp);
      renderSelectedList();
      applySelectionToTable();
      updateSearchSummaryForSelection();
    });
    selectedListEl.appendChild(span);
  });
}

/* If selection empty -> show all employees (depending on admin/user); else show only selected rows */
function applySelectionToTable(){
  const table = document.getElementById("attendanceTable");
  if(!table) return;
  const rows = Array.from(table.querySelectorAll("tr"));
  if(selectedEmployees.length === 0){
    generateTable();
    return;
  }
  rows.forEach((tr, idx)=>{
    if(idx === 0) { tr.style.display = ''; return; }
    const empCell = tr.querySelector('td:first-child');
    if(!empCell) return;
    const emp = empCell.textContent.trim();
    const shouldShow = selectedEmployees.includes(emp);
    tr.style.display = shouldShow ? '' : 'none';
    tr.classList.toggle('highlight-row', shouldShow);
  });
}

/* Clear selection and restore search input and table */
function clearEmployeeFilter(){
  document.getElementById('employeeSearch').value = '';
  selectedEmployees = [];
  renderSelectedList();
  clearDateHighlights();
  document.getElementById('searchSummary').innerHTML = '';
  generateTable();
}

/* ===== Highlight helpers ===== */
function highlightDatesForEmployeesStatus(employeeNames, status){
  clearDateHighlights();
  if(!employeeNames || employeeNames.length === 0 || !status) return;
  const table = document.getElementById('attendanceTable');
  if(!table) return;
  let firstHighlightedCell = null;
  const ths = Array.from(document.querySelectorAll('#attendanceTable th'));

  for(const emp of employeeNames){
    const rows = Array.from(table.querySelectorAll('tr'));
    for(let i=1;i<rows.length;i++){
      const tr = rows[i];
      const empCell = tr.querySelector('td:first-child');
      if(!empCell) continue;
      if(empCell.textContent.trim() !== emp) continue;
      const tds = Array.from(tr.querySelectorAll('td')).slice(1);
      const monthVal = document.getElementById('monthPicker').value;
      if(!monthVal) continue;
      const [year, monthNum] = monthVal.split("-");
      for(let d=0; d<tds.length; d++){
        const cell = tds[d];
        if(cell.classList.contains('weekend')) continue;
        const day = d+1;
        const key1 = `${emp}_${year}-${monthNum}-${day}`;
        const val = attendanceData[key1];
        if(val === status){
          cell.classList.add('date-highlight');
          cell.setAttribute('data-status', status);
          cell.setAttribute('data-emp', emp);
          if(!firstHighlightedCell) firstHighlightedCell = cell;
        }
      }
      break;
    }
  }

  if(firstHighlightedCell){
    try{
      firstHighlightedCell.parentElement.scrollIntoView({behavior:'smooth', block:'center'});
      const cellIndex = Array.from(firstHighlightedCell.parentElement.children).indexOf(firstHighlightedCell);
      const ths = Array.from(document.querySelectorAll('#attendanceTable th'));
      const targetTh = ths[cellIndex];
      const wrapper = document.querySelector('.table-wrapper');
      if(wrapper && targetTh){
        const firstTh = ths[0];
        const desired = Math.max(0, targetTh.offsetLeft - firstTh.offsetWidth - 8);
        wrapper.scrollTo({ left: desired, behavior: 'smooth' });
      } else {
        firstHighlightedCell.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
      }
    } catch(e){ console.warn('scroll to highlighted failed', e); }
  }
}

function clearDateHighlights(){
  document.querySelectorAll('.date-highlight').forEach(el => {
    el.classList.remove('date-highlight');
    el.removeAttribute('data-status');
    el.removeAttribute('data-emp');
  });
}

/* ===== Table generation (user-limited visibility + auto-scroll) ===== */
let lastStatusFilter = null;
function scrollToTableColumn(table, colIndex){
  try{
    const wrapper = document.querySelector('.table-wrapper');
    if(!wrapper) return;
    const ths = Array.from(table.querySelectorAll('th'));
    if(colIndex < 0 || colIndex >= ths.length) return;
    const targetTh = ths[colIndex];
    const firstTh = ths[0];
    const targetOffset = targetTh.offsetLeft;
    const firstWidth = firstTh.offsetWidth;
    const desiredScrollLeft = Math.max(0, targetOffset - firstWidth - 8);
    wrapper.scrollTo({ left: desiredScrollLeft, behavior: 'smooth' });
  } catch(e){ console.warn('scrollToTableColumn error', e); }
}

function generateTable(){
  const month=document.getElementById("monthPicker").value; if(!month) return;
  const [year, monthNum]=month.split("-");
  const daysInMonth=new Date(year,monthNum,0).getDate();
  const table=document.getElementById("attendanceTable"); table.innerHTML="";
  let headerRow=`<tr><th>Employee</th>`;
  for(let d=1; d<=daysInMonth; d++){
    const date=new Date(year, monthNum-1,d);
    const day=date.toLocaleDateString("en-US",{weekday:"short"});
    headerRow+=`<th>${d}<br>${day}</th>`;
  }
  headerRow+="</tr>"; table.innerHTML=headerRow;

  const today = new Date(); today.setHours(0,0,0,0);

  let employeesToShow;
  if(window.isAdmin) employeesToShow = employees.slice();
  else if(window.currentUser) employeesToShow = employees.includes(window.currentUser) ? [window.currentUser] : [window.currentUser];
  else employeesToShow = [];

  employeesToShow.forEach(emp=>{
    let row=`<tr${(window.currentUser && window.currentUser === emp) ? ' class="highlight-row"' : '' }><td>${emp}</td>`;
    for(let d=1; d<=daysInMonth; d++){
      const date=new Date(year, monthNum-1,d);
      const key=`${emp}_${year}-${monthNum}-${d}`;
      let val=attendanceData[key]||"";
      if(date.getDay()===0||date.getDay()===6){
        row+=`<td class="weekend">Week Off</td>`;
      } else if(date < today){
        row+=`<td style="background:${colors[val]||'transparent'}">${val||""}</td>`;
      } else {
        const canEdit = (window.isAdmin === true) || (window.currentUser && window.currentUser === emp);
        if(canEdit){
          row+=`<td style="background:${colors[val]||'transparent'}">
            <select onchange="updateData('${key}', this.value)">
              <option value="">Select</option>
              <option value="WFO" ${val==="WFO"?"selected":""}>WFO</option>
              <option value="WFH" ${val==="WFH"?"selected":""}>WFH</option>
              <option value="Leave" ${val==="Leave"?"selected":""}>Leave</option>
              <option value="Holiday" ${val==="Holiday"?"selected":""}>Holiday</option>
            </select>
          </td>`;
        } else {
          row+=`<td style="background:${colors[val]||'transparent'}">${val||""}</td>`;
        }
      }
    }
    row+="</tr>"; table.innerHTML+=row;
  });

  try {
    const monthVal = document.getElementById("monthPicker").value;
    if(monthVal){
      const [y, m] = monthVal.split("-");
      const today = new Date();
      const todayY = today.getFullYear();
      const todayM = String(today.getMonth()+1).padStart(2,'0');
      const todayD = today.getDate();
      if(String(y) === String(todayY) && String(m) === String(todayM)){
        const ths = Array.from(table.querySelectorAll("th"));
        let foundIndex = -1;
        for(let i=1;i<ths.length;i++){
          const txt = ths[i].innerText.trim().split("\n")[0].trim();
          if(String(txt) === String(todayD) || Number(txt) === todayD){ foundIndex = i; break; }
        }
        if(foundIndex >= 1){
          scrollToTableColumn(table, foundIndex);
          const hdr = table.querySelectorAll('th')[foundIndex];
          if(hdr){ hdr.style.outline = '3px solid rgba(9,132,227,0.6)'; setTimeout(()=>{ hdr.style.outline=''; },2200); }
        }
      }
    }
  } catch(e){ console.warn("Auto-scroll to today's column failed:", e); }

  updateCharts();
  refreshEmployeeDatalist();

  if(selectedEmployees.length > 0){
    renderSelectedList();
    applySelectionToTable();
    updateSearchSummaryForSelection();
  }

  if(lastStatusFilter) filterRowsByStatus(lastStatusFilter);
}

/* ===== Bulk update / Excel / load (with admin guards) ===== */
function applyBulkUpdate(){
  if(!window.isAdmin){ alert("Bulk update requires admin access."); return; }
  const status = document.getElementById("bulkStatus").value;
  const start = parseInt(document.getElementById("bulkStart").value);
  const end = parseInt(document.getElementById("bulkEnd").value);
  const monthVal = document.getElementById("monthPicker").value;
  if(!monthVal || isNaN(start) || isNaN(end)) return;
  const [year, monthNum] = monthVal.split("-");
  const today = new Date(); today.setHours(0,0,0,0);

  employees.forEach(emp=>{
    for(let d=start; d<=end; d++){
      const date = new Date(year, monthNum-1, d);
      if(date >= today){
        attendanceData[`${emp}_${year}-${monthNum}-${d}`] = status;
      }
    }
  });

  saveToFirebase();
  generateTable();
}

function saveToExcel(){
  if(!window.isAdmin){
    alert("Admin access required to download attendance data.");
    return;
  }

  let ws_data = [["Employee","Date","Status"]];
  for(let key in attendanceData){
    let [emp,date] = key.split("_");
    ws_data.push([emp,date,attendanceData[key]]);
  }
  let ws = XLSX.utils.aoa_to_sheet(ws_data);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Attendance");
  XLSX.writeFile(wb, "Attendance.xlsx");
}

function loadFromExcel(event){
  if(!window.isAdmin){
    alert("Admin access required to upload attendance data.");
    try { if(event && event.target) event.target.value = ""; } catch(e){}
    return;
  }

  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    const tmpAttendance = {};
    const tmpEmployees = new Set();
    let firstDate = null;
    json.slice(1).forEach(row => {
      if(row.length >= 3){
        const [emp,date,val] = row;
        tmpEmployees.add(emp);
        tmpAttendance[`${emp}_${date}`] = val;
        if(!firstDate) firstDate = date;
      }
    });
    attendanceData = tmpAttendance;
    employees = Array.from(tmpEmployees);
    if(firstDate){
      const [year, month] = String(firstDate).split("-");
      const monthInput = document.getElementById("monthPicker");
      if (year && month && monthInput) monthInput.value = `${year}-${String(month).padStart(2,'0')}`;
    }
    saveToFirebase();
    refreshEmployeeDatalist();
    generateTable();
  };
  reader.readAsArrayBuffer(file);
}

/* ===== Chart plugin ===== */
const DepthBars = {
  id: 'depthBars',
  afterDatasetsDraw(chart){
    const {ctx} = chart;
    ctx.save();
    ctx.shadowColor = 'rgba(0,0,0,.35)';
    ctx.shadowBlur = 12;
    ctx.shadowOffsetY = 6;

    chart.getSortedVisibleDatasetMetas().forEach(meta=>{
      if (meta.type !== 'bar') return;
      meta.data.forEach(el=>{
        if (!el || !el.base) return;
        const {x,y,base,width} = el.getProps(['x','y','base','width'], true);
        const left = x - width/2;
        const top = y;
        const height = base - y;

        const grad = ctx.createLinearGradient(0, top, 0, top + height);
        grad.addColorStop(0, 'rgba(255,255,255,.10)');
        grad.addColorStop(1, 'rgba(0,0,0,.10)');

        ctx.fillStyle = grad;
        ctx.fillRect(left, top, width, height);
      });
    });

    ctx.restore();
  }
};
Chart.register(DepthBars);

/* === Twinkling Stars === */
(function(){
  const canvas = document.getElementById('stars-bg');
  const ctx = canvas.getContext('2d');
  let stars = [], width, height, devicePxRatio;

  function resize(){
    width = window.innerWidth;
    height = window.innerHeight;
    devicePxRatio = window.devicePixelRatio || 1;
    canvas.width = Math.floor(width * devicePxRatio);
    canvas.height = Math.floor(height * devicePxRatio);
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    ctx.setTransform(devicePxRatio, 0, 0, devicePxRatio, 0, 0);
    initStars();
  }
  function initStars(){
    stars=[];
    const count = Math.min(220, Math.max(120, Math.floor(width * height * 0.00012)));
    for(let i=0;i<count;i++){
      stars.push({ x:Math.random()*width, y:Math.random()*height, r:Math.random()*1.6+0.4, alpha:Math.random(), dAlpha:(Math.random()*0.02+0.006)*(Math.random()<0.5?-1:1) });
    }
  }
  function animate(){
    ctx.clearRect(0,0,width,height);
    for(const s of stars){
      s.alpha += s.dAlpha;
      if(s.alpha <= 0){ s.alpha = 0; s.dAlpha *= -1; }
      else if(s.alpha >= 1){ s.alpha = 1; s.dAlpha *= -1; }
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
      ctx.shadowBlur = 8; ctx.shadowColor = "rgba(255,255,255,0.8)";
      ctx.fill(); ctx.shadowBlur = 0;
    }
    requestAnimationFrame(animate);
  }
  window.addEventListener('resize', resize, { passive:true });
  resize(); animate();
})();

/* === Particle Background === */
(function(){
  const canvas = document.getElementById('particles-bg');
  const ctx = canvas.getContext('2d');
  let particles = [], width, height, devicePxRatio;

  function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    devicePxRatio = window.devicePixelRatio || 1;
    canvas.width = Math.floor(width * devicePxRatio);
    canvas.height = Math.floor(height * devicePxRatio);
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    ctx.setTransform(devicePxRatio, 0, 0, devicePxRatio, 0, 0);
    initParticles();
  }

  function initParticles() {
    const density = 0.00012;
    const targetCount = Math.min(220, Math.max(80, Math.floor(width * height * density)));
    particles = [];
    for (let i = 0; i < targetCount; i++) {
      particles.push({ x:Math.random()*width, y:Math.random()*height, vx:(Math.random()-0.5)*0.6, vy:(Math.random()-0.5)*0.6, r:Math.random()*1.6+0.6, a:Math.random()*0.6+0.3 });
    }
  }

  function step() {
    ctx.clearRect(0, 0, width, height);
    const maxDist = Math.min(160, Math.max(90, Math.min(width, height) * 0.18));

    for (let i = 0; i < particles.length; i++) {
      const p = particles[i];
      p.x += p.vx; p.y += p.vy;
      if (p.x < -10) p.x = width + 10;
      if (p.x > width + 10) p.x = -10;
      if (p.y < -10) p.y = height + 10;
      if (p.y > height + 10) p.y = -10;

      ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255,255,255,' + p.a + ')';
      ctx.shadowBlur = 12; ctx.shadowColor = "rgba(255,255,255,0.6)";
      ctx.fill(); ctx.shadowBlur = 0;
    }

    ctx.lineWidth = 0.7;
    for (let i = 0; i < particles.length; i++) {
      for (let j = i + 1; j < particles.length; j++) {
        const p1 = particles[i], p2 = particles[j];
        const dx = p1.x - p2.x, dy = p1.y - p2.y;
        const dist2 = dx*dx + dy*dy;
        if (dist2 < maxDist*maxDist) {
          const dist = Math.sqrt(dist2);
          const alpha = 1 - dist / maxDist;
          ctx.strokeStyle = 'rgba(255,255,255,' + (alpha * 0.25) + ')';
          ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
        }
      }
    }
    requestAnimationFrame(step);
  }
  window.addEventListener('resize', resize, { passive: true });
  resize(); requestAnimationFrame(step);
})();

/* ===== Visualization toggle wiring (default Monthly/current month) ===== */
(function(){
  const dailyBtn = document.getElementById('vizDailyBtn');
  const monthlyBtn = document.getElementById('vizMonthlyBtn');
  const monthlyPicker = document.getElementById('monthlyPicker');
  const dayPicker = document.getElementById('dayPicker');

  function setDaily(){
    dailyBtn.classList.add('active');
    monthlyBtn.classList.remove('active');
    if(monthlyPicker) monthlyPicker.style.display = 'none';
    if(dayPicker) dayPicker.disabled = false;
    updateCharts();
  }
  function setMonthly(){
    monthlyBtn.classList.add('active');
    dailyBtn.classList.remove('active');
    if(monthlyPicker) monthlyPicker.style.display = 'inline-block';
    if(dayPicker) dayPicker.disabled = true;
    const monthInput = document.getElementById('monthPicker');
    if(monthlyPicker && !monthlyPicker.value && monthInput && monthInput.value) monthlyPicker.value = monthInput.value;
    updateCharts();
  }

  if(dailyBtn && monthlyBtn){
    dailyBtn.addEventListener('click', setDaily);
    monthlyBtn.addEventListener('click', setMonthly);
    // DEFAULT: Monthly (current month)
    setMonthly();
  }
})();

/* ===== Chart helpers + combined updateCharts() ===== */
function createGradient(ctx, color){
  const gradient = ctx.createLinearGradient(0,0,0,350);
  gradient.addColorStop(0, lightenColor(color,0.3));
  gradient.addColorStop(1, color);
  return gradient;
}
function lightenColor(hex, lum) {
  hex = String(hex).replace(/[^0-9a-f]/gi, '');
  if(hex.length<6){ hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]; }
  let rgb="#", c, i;
  for(i=0;i<3;i++){ c=parseInt(hex.substr(i*2,2),16); c=Math.min(255,Math.max(0,c+Math.round(255*lum))).toString(16); while(c.length<2)c="0"+c; rgb+=c; }
  return rgb;
}

function updateCharts(){
  const monthlyToggleVisible = document.getElementById('vizMonthlyBtn').classList.contains('active');
  const combinedTitle = document.getElementById('combinedChartTitle');
  const monthlyPicker = document.getElementById('monthlyPicker');
  const dayPicker = document.getElementById('dayPicker');

  // Default to current month for monthly view
  if(monthlyToggleVisible){
    if(!monthlyPicker.value){
      const monthInput = document.getElementById('monthPicker');
      if(monthInput && monthInput.value) monthlyPicker.value = monthInput.value;
      else {
        const now = new Date();
        monthlyPicker.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      }
    }
  }

  const summary={}, employeeNames={};
  const ctx = document.getElementById("combinedChart").getContext("2d");

  if(monthlyToggleVisible){
    combinedTitle.textContent = "Monthly Summary";
    dayPicker.disabled = true;
    monthlyPicker.style.display = 'inline-block';

    const [year, monthNum] = monthlyPicker.value.split("-");
    const monthSummary = {};

    // Alphabetical order
    const empsSorted = employees.slice().sort((a,b)=>a.localeCompare(b));
    const days = new Date(year, monthNum, 0).getDate();
    empsSorted.forEach(emp=>{
      for(let d=1; d<=days; d++){
        const dPad = String(d).padStart(2,'0');
        const key1 = `${emp}_${year}-${monthNum}-${dPad}`;
        const key2 = `${emp}_${year}-${monthNum}-${d}`;
        const val = attendanceData[key1] || attendanceData[key2];
        if(colors[val]){
          summary[val] = (summary[val]||0) + 1;
          if(!monthSummary[emp]) monthSummary[emp] = {};
          monthSummary[emp][val] = (monthSummary[emp][val]||0) + 1;
        }
      }
    });

    const statuses = ["WFO","WFH","Leave","Holiday"];
    const labels = empsSorted;

    // Dynamic canvas width for scroll: 80px per employee (show at least TOP_N)
    const canvas = document.getElementById("combinedChart");
    const pxPerEmp = 80;
    const baseWidth = Math.max(TOP_N * pxPerEmp, Math.max(1, labels.length) * pxPerEmp);
    canvas.style.width = baseWidth + 'px';
    canvas.width = baseWidth;

    const datasets = statuses.map(s => ({
      label: s,
      data: labels.map(emp => monthSummary[emp] ? (monthSummary[emp][s]||0) : 0),
      backgroundColor: createGradient(ctx, colors[s]),
      borderRadius: 8,
      maxBarThickness: 40,
      stack: 'month'
    }));

    const options = {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding:{top:8,right:16,bottom:28,left:16} },
      plugins: {
        tooltip: { mode: "index" },
        legend: {
          onClick: function(e, legendItem, legend){
            const index = legendItem.datasetIndex;
            const ci = legend.chart;
            const alreadyIsolated = ci.data.datasets.every((ds, i) => 
              (i === index && ci.getDatasetMeta(i).hidden !== true) ||
              (i !== index && ci.getDatasetMeta(i).hidden === true)
            );
            const allHidden = ci.data.datasets.every((ds, i) => ci.getDatasetMeta(i).hidden === true);
            if (alreadyIsolated || allHidden) {
              ci.data.datasets.forEach((ds, i) => { ci.getDatasetMeta(i).hidden = false; });
            } else {
              ci.data.datasets.forEach((ds, i) => { ci.getDatasetMeta(i).hidden = i !== index; });
            }
            ci.update();
          }
        }
      },
      scales: {
        x: {
          stacked: true,
          ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 },
          grid: { color: "rgba(255,255,255,0.05)" }
        },
        y: { stacked: true, beginAtZero: true, grid: { color:"rgba(255,255,255,0.1)" } }
      },
      animation: { duration: 800, easing: 'easeOutQuart' }
    };

    if(barChart) barChart.destroy();
    barChart = new Chart(ctx, { type: "bar", data: { labels, datasets }, options });

    // Scroll so first TOP_N are visible by default
    const scroller = document.getElementById('chartScroller');
    scroller.scrollLeft = 0;

  } else {
    combinedTitle.textContent = "Attendance Distribution";
    dayPicker.disabled = false;
    monthlyPicker.style.display = 'none';

    if(!dayPicker.value){
      const now = new Date();
      const monthValue = document.getElementById('monthPicker').value;
      if(monthValue){
        const [y,m] = monthValue.split("-");
        const todayInThatMonth = new Date(Number(y), Number(m)-1, Math.min(now.getDate(), new Date(y,m,0).getDate()));
        dayPicker.value = `${y}-${m}-${String(todayInThatMonth.getDate()).padStart(2,'0')}`;
      } else {
        dayPicker.value = now.toISOString().slice(0,10);
      }
    }

    const [y, m, dPad] = dayPicker.value.split("-");
    const dUnpadded = String(parseInt(dPad, 10));
    const empsSorted = employees.slice().sort((a,b)=>a.localeCompare(b));
    empsSorted.forEach(emp=>{
      const k1 = `${emp}_${y}-${m}-${dPad}`;
      const k2 = `${emp}_${y}-${m}-${dUnpadded}`;
      const val = attendanceData[k1] || attendanceData[k2];
      if(colors[val]){
        summary[val]=(summary[val]||0)+1;
        employeeNames[val] = employeeNames[val] || [];
        employeeNames[val].push(emp);
      }
    });

    const labels = Object.keys(summary);
    const data = Object.values(summary);

    const canvas = document.getElementById("combinedChart");
    canvas.style.width = '100%';

    const dataSet = [{
      data,
      backgroundColor: labels.map(k => createGradient(ctx, colors[k])),
      borderRadius: 8
    }];

    const options = {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding:{top:8,right:16,bottom:28,left:16} },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context){
              const label = context.label;
              const names = employeeNames[label] || [];
              return `${label}: ${context.raw}` + (names.length ? ` (${names.join(", ")})` : '');
            }
          }
        }
      },
      scales: {
        y: { beginAtZero: true, grid:{ color:"rgba(255,255,255,0.1)" } },
        x: { offset:true, ticks:{autoSkip:true,maxRotation:45,minRotation:0}, grid:{ color:"rgba(255,255,255,0.05)" } }
      },
      animation: { duration: 800, easing: 'easeOutQuart' }
    };

    if(barChart) barChart.destroy();
    barChart = new Chart(ctx, { type: "bar", data: { labels, datasets: dataSet }, options });
  }
}

/* ===== Search summary badges ===== */
function updateSearchSummaryForSelection(){
  const summaryEl = document.getElementById("searchSummary");
  summaryEl.innerHTML = '';
  clearDateHighlights();

  if(selectedEmployees.length === 0) return;

  const monthVal = document.getElementById("monthPicker").value;
  if(!monthVal) return;
  const [year, monthNum] = monthVal.split("-");
  const daysInMonth = new Date(year, monthNum, 0).getDate();

  const counts = { WFO:0, WFH:0, Leave:0, Holiday:0 };
  const groupedDates = { WFO:{}, WFH:{}, Leave:{}, Holiday:{} };

  selectedEmployees.forEach(emp => {
    for(let d=1; d<=daysInMonth; d++){
      const key = `${emp}_${year}-${monthNum}-${d}`;
      const val = attendanceData[key];
      if(counts.hasOwnProperty(val)){
        counts[val]++;
        groupedDates[val][emp] = groupedDates[val][emp] || [];
        groupedDates[val][emp].push(d);
      }
    }
  });

  const wrapper = document.createElement('div');
  wrapper.className = 'capsule-badges';
  const appendBadge = (label, count, color) => {
    const span = document.createElement('span');
    span.className = 'badge';
    span.dataset.status = label;
    span.style.background = color;
    span.textContent = `${label}: ${count}`;
    if(label === 'Holiday') span.style.color = '#111';
    else span.style.color = '#fff';

    const groups = groupedDates[label];
    const parts=[];
    for(const emp of Object.keys(groups)){
      if(groups[emp].length>0) parts.push(`${emp}: ${groups[emp].join(',')}`);
    }
    span.title = parts.length ? `Dates â€” ${parts.join('  â€”  ')}` : `No ${label} days for selection`;

    wrapper.appendChild(span);
  };

  appendBadge('WFO', counts.WFO, colors.WFO);
  appendBadge('WFH', counts.WFH, colors.WFH);
  appendBadge('Leave', counts.Leave, colors.Leave);
  appendBadge('Holiday', counts.Holiday, colors.Holiday);

  summaryEl.appendChild(wrapper);

  wrapper.addEventListener('click', (ev) => {
    const badge = ev.target.closest('.badge');
    if(!badge) return;
    const status = badge.dataset.status;
    const currentlyActive = badge.classList.contains('active');
    wrapper.querySelectorAll('.badge').forEach(b => b.classList.remove('active'));
    clearDateHighlights();
    if(!currentlyActive){
      badge.classList.add('active');
      highlightDatesForEmployeesStatus(selectedEmployees, status);
    }
  });
}

/* Filter rows by status (kept for potential use) */
function filterRowsByStatus(status){
  const monthVal = document.getElementById("monthPicker").value;
  if(!monthVal) return;
  const [year, monthNum] = monthVal.split("-");
  const daysInMonth = new Date(year, monthNum, 0).getDate();
  const table = document.getElementById("attendanceTable");
  Array.from(table.querySelectorAll('tr')).forEach((tr, idx) => {
    if(idx === 0){ tr.style.display = ""; return; }
    const empCell = tr.querySelector('td:first-child');
    if(!empCell) return;
    const emp = empCell.textContent.trim();
    let hasStatus = false;
    for(let d=1; d<=daysInMonth; d++){
      const key1 = `${emp}_${year}-${monthNum}-${d}`;
      const val = attendanceData[key1];
      if(val === status){ hasStatus = true; break; }
    }
    tr.style.display = hasStatus ? "" : "none";
    tr.classList.toggle('highlight-row', hasStatus);
  });
  lastStatusFilter = status;
}

/* Initialize defaults and restore session */
window.addEventListener("DOMContentLoaded", ()=>{
  const monthInput = document.getElementById("monthPicker");
  if(monthInput && !monthInput.value){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,'0');
    monthInput.value = `${yyyy}-${mm}`;
  }

  const storedUser = localStorage.getItem(SESSION_USER_KEY);
  const storedAdmin = localStorage.getItem(SESSION_ADMIN_KEY);
  if(storedUser) window.currentUser = storedUser;
  if(storedAdmin) window.isAdmin = true;
  updateSessionUI();

  if(window.currentUser || window.isAdmin){
    hideOverlay();
  } else {
    showOverlay();
  }

  refreshEmployeeDatalist();
  generateTable();
});

/* Expose some functions for inline handlers */
window.updateData = updateData;
window.generateTable = generateTable;
window.saveToExcel = saveToExcel;
window.loadFromExcel = (e) => { fileInput.files = e.target.files; loadFromExcel({ target: fileInput }); };
window.applyBulkUpdate = applyBulkUpdate;
window.addEmployee = ()=> document.getElementById('addEmployeeBtn').click();
window.removeEmployee = ()=> document.getElementById('removeEmployeeBtn').click();

</script>
</body>
</html>

